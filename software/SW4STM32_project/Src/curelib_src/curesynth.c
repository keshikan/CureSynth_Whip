/*
 *******************************************************************************
 *  [curesynth.c]
 *  This module is for sound generation.
 *
 *  This program is under the terms of the GPLv3.
 *  https://www.gnu.org/licenses/gpl-3.0.html
 *
 *  Copyright(c) 2017 Keshikan (www.keshikan.net)
 *******************************************************************************
 */

#include "curelib_inc/curesynth.h"


//use dsp lib
#define ARM_MATH_CM7
#include "stm32f7xx_hal.h"
#include <arm_math.h>
#include <arm_const_structs.h>
#include "subdsp.h"


/////const variables/////
const float const_pitch_scalefactor = ( (float)(SAMPLE_NUM) / (float)SAMPLE_RATE );
const float const_triangle_scalefactor = (AUDIO_MAX_NUM - AUDIO_MIN_NUM) / (SAMPLE_NUM >> 1);
const float const_saw_scalefactor = (AUDIO_MAX_NUM - AUDIO_MIN_NUM) / (SAMPLE_NUM - 1);
const float const_mod_scalefactor = ( (float)(MODTABLE_NUM) / (float)SAMPLE_RATE );

//sample=4096
const int16_t SineTable[SAMPLE_NUM]
							={0, 50, 101, 151, 201, 251, 302, 352, 402, 452, 503, 553, 603, 653, 704, 754, 804, 854, 905, 955, 1005, 1055, 1106, 1156, 1206, 1256, 1307, 1357, 1407, 1457, 1507, 1558, 1608, 1658, 1708, 1758, 1809, 1859, 1909, 1959, 2009, 2059, 2110, 2160, 2210, 2260, 2310, 2360, 2410, 2461, 2511, 2561, 2611, 2661, 2711, 2761, 2811, 2861, 2911, 2962, 3012, 3062, 3112, 3162, 3212, 3262, 3312, 3362, 3412, 3462, 3512, 3562, 3612, 3662, 3712, 3761, 3811, 3861, 3911, 3961, 4011, 4061, 4111, 4161, 4210, 4260, 4310, 4360, 4410, 4460, 4509, 4559, 4609, 4659, 4708, 4758, 4808, 4858, 4907, 4957, 5007, 5056, 5106, 5156, 5205, 5255, 5305, 5354, 5404, 5453, 5503, 5552, 5602, 5651, 5701, 5750, 5800, 5849, 5899, 5948, 5998, 6047, 6096, 6146, 6195, 6245, 6294, 6343, 6393, 6442, 6491, 6540, 6590, 6639, 6688, 6737, 6786, 6836, 6885, 6934, 6983, 7032, 7081, 7130, 7179, 7228, 7277, 7326, 7375, 7424, 7473, 7522, 7571, 7620, 7669, 7718, 7767, 7815, 7864, 7913, 7962, 8010, 8059, 8108, 8157, 8205, 8254, 8303, 8351, 8400, 8448, 8497, 8545, 8594, 8642, 8691, 8739, 8788, 8836, 8885, 8933, 8981, 9030, 9078, 9126, 9175, 9223, 9271, 9319, 9367, 9416, 9464, 9512, 9560, 9608, 9656, 9704, 9752, 9800, 9848, 9896, 9944, 9992, 10039, 10087, 10135, 10183, 10231, 10278, 10326, 10374, 10421, 10469, 10517, 10564, 10612, 10659, 10707, 10754, 10802, 10849, 10897, 10944, 10992, 11039, 11086, 11133, 11181, 11228, 11275, 11322, 11370, 11417, 11464, 11511, 11558, 11605, 11652, 11699, 11746, 11793, 11840, 11886, 11933, 11980, 12027, 12074, 12120, 12167, 12214, 12260, 12307, 12353, 12400, 12446, 12493, 12539, 12586, 12632, 12679, 12725, 12771, 12817, 12864, 12910, 12956, 13002, 13048, 13094, 13141, 13187, 13233, 13279, 13324, 13370, 13416, 13462, 13508, 13554, 13599, 13645, 13691, 13736, 13782, 13828, 13873, 13919, 13964, 14010, 14055, 14101, 14146, 14191, 14236, 14282, 14327, 14372, 14417, 14462, 14507, 14553, 14598, 14643, 14688, 14732, 14777, 14822, 14867, 14912, 14956, 15001, 15046, 15090, 15135, 15180, 15224, 15269, 15313, 15358, 15402, 15446, 15491, 15535, 15579, 15623, 15667, 15712, 15756, 15800, 15844, 15888, 15932, 15976, 16019, 16063, 16107, 16151, 16195, 16238, 16282, 16325, 16369, 16413, 16456, 16499, 16543, 16586, 16630, 16673, 16716, 16759, 16802, 16846, 16889, 16932, 16975, 17018, 17061, 17104, 17146, 17189, 17232, 17275, 17317, 17360, 17403, 17445, 17488, 17530, 17573, 17615, 17657, 17700, 17742, 17784, 17827, 17869, 17911, 17953, 17995, 18037, 18079, 18121, 18163, 18204, 18246, 18288, 18330, 18371, 18413, 18454, 18496, 18537, 18579, 18620, 18661, 18703, 18744, 18785, 18826, 18868, 18909, 18950, 18991, 19032, 19072, 19113, 19154, 19195, 19236, 19276, 19317, 19357, 19398, 19438, 19479, 19519, 19560, 19600, 19640, 19680, 19721, 19761, 19801, 19841, 19881, 19921, 19961, 20000, 20040, 20080, 20120, 20159, 20199, 20238, 20278, 20317, 20357, 20396, 20436, 20475, 20514, 20553, 20592, 20631, 20670, 20709, 20748, 20787, 20826, 20865, 20904, 20942, 20981, 21019, 21058, 21096, 21135, 21173, 21212, 21250, 21288, 21326, 21364, 21403, 21441, 21479, 21516, 21554, 21592, 21630, 21668, 21705, 21743, 21781, 21818, 21856, 21893, 21930, 21968, 22005, 22042, 22079, 22116, 22154, 22191, 22227, 22264, 22301, 22338, 22375, 22411, 22448, 22485, 22521, 22558, 22594, 22631, 22667, 22703, 22739, 22776, 22812, 22848, 22884, 22920, 22956, 22991, 23027, 23063, 23099, 23134, 23170, 23205, 23241, 23276, 23311, 23347, 23382, 23417, 23452, 23487, 23522, 23557, 23592, 23627, 23662, 23697, 23731, 23766, 23801, 23835, 23870, 23904, 23938, 23973, 24007, 24041, 24075, 24109, 24143, 24177, 24211, 24245, 24279, 24312, 24346, 24380, 24413, 24447, 24480, 24514, 24547, 24580, 24613, 24647, 24680, 24713, 24746, 24779, 24811, 24844, 24877, 24910, 24942, 24975, 25007, 25040, 25072, 25105, 25137, 25169, 25201, 25233, 25265, 25297, 25329, 25361, 25393, 25425, 25456, 25488, 25519, 25551, 25582, 25614, 25645, 25676, 25708, 25739, 25770, 25801, 25832, 25863, 25893, 25924, 25955, 25986, 26016, 26047, 26077, 26108, 26138, 26168, 26198, 26229, 26259, 26289, 26319, 26349, 26378, 26408, 26438, 26468, 26497, 26527, 26556, 26586, 26615, 26644, 26674, 26703, 26732, 26761, 26790, 26819, 26848, 26876, 26905, 26934, 26962, 26991, 27019, 27048, 27076, 27104, 27133, 27161, 27189, 27217, 27245, 27273, 27300, 27328, 27356, 27384, 27411, 27439, 27466, 27493, 27521, 27548, 27575, 27602, 27629, 27656, 27683, 27710, 27737, 27764, 27790, 27817, 27843, 27870, 27896, 27923, 27949, 27975, 28001, 28027, 28053, 28079, 28105, 28131, 28157, 28182, 28208, 28234, 28259, 28284, 28310, 28335, 28360, 28385, 28411, 28436, 28460, 28485, 28510, 28535, 28560, 28584, 28609, 28633, 28658, 28682, 28706, 28730, 28755, 28779, 28803, 28827, 28850, 28874, 28898, 28922, 28945, 28969, 28992, 29016, 29039, 29062, 29085, 29108, 29131, 29154, 29177, 29200, 29223, 29246, 29268, 29291, 29313, 29336, 29358, 29380, 29403, 29425, 29447, 29469, 29491, 29513, 29534, 29556, 29578, 29599, 29621, 29642, 29664, 29685, 29706, 29728, 29749, 29770, 29791, 29812, 29832, 29853, 29874, 29894, 29915, 29936, 29956, 29976, 29997, 30017, 30037, 30057, 30077, 30097, 30117, 30136, 30156, 30176, 30195, 30215, 30234, 30253, 30273, 30292, 30311, 30330, 30349, 30368, 30387, 30406, 30424, 30443, 30462, 30480, 30498, 30517, 30535, 30553, 30571, 30589, 30607, 30625, 30643, 30661, 30679, 30696, 30714, 30731, 30749, 30766, 30783, 30800, 30818, 30835, 30852, 30868, 30885, 30902, 30919, 30935, 30952, 30968, 30985, 31001, 31017, 31033, 31050, 31066, 31082, 31097, 31113, 31129, 31145, 31160, 31176, 31191, 31206, 31222, 31237, 31252, 31267, 31282, 31297, 31312, 31327, 31341, 31356, 31371, 31385, 31400, 31414, 31428, 31442, 31456, 31470, 31484, 31498, 31512, 31526, 31539, 31553, 31567, 31580, 31593, 31607, 31620, 31633, 31646, 31659, 31672, 31685, 31698, 31710, 31723, 31736, 31748, 31760, 31773, 31785, 31797, 31809, 31821, 31833, 31845, 31857, 31869, 31880, 31892, 31903, 31915, 31926, 31937, 31949, 31960, 31971, 31982, 31993, 32004, 32014, 32025, 32036, 32046, 32057, 32067, 32077, 32087, 32098, 32108, 32118, 32128, 32137, 32147, 32157, 32166, 32176, 32185, 32195, 32204, 32213, 32223, 32232, 32241, 32250, 32258, 32267, 32276, 32285, 32293, 32302, 32310, 32318, 32327, 32335, 32343, 32351, 32359, 32367, 32375, 32382, 32390, 32397, 32405, 32412, 32420, 32427, 32434, 32441, 32448, 32455, 32462, 32469, 32476, 32482, 32489, 32495, 32502, 32508, 32514, 32521, 32527, 32533, 32539, 32545, 32550, 32556, 32562, 32567, 32573, 32578, 32584, 32589, 32594, 32599, 32604, 32609, 32614, 32619, 32624, 32628, 32633, 32637, 32642, 32646, 32650, 32655, 32659, 32663, 32667, 32671, 32674, 32678, 32682, 32685, 32689, 32692, 32696, 32699, 32702, 32705, 32708, 32711, 32714, 32717, 32720, 32722, 32725, 32728, 32730, 32732, 32735, 32737, 32739, 32741, 32743, 32745, 32747, 32748, 32750, 32752, 32753, 32755, 32756, 32757, 32758, 32759, 32760, 32761, 32762, 32763, 32764, 32765, 32765, 32766, 32766, 32766, 32767, 32767, 32767, 32767, 32767, 32767, 32767, 32766, 32766, 32766, 32765, 32765, 32764, 32763, 32762, 32761, 32760, 32759, 32758, 32757, 32756, 32755, 32753, 32752, 32750, 32748, 32747, 32745, 32743, 32741, 32739, 32737, 32735, 32732, 32730, 32728, 32725, 32722, 32720, 32717, 32714, 32711, 32708, 32705, 32702, 32699, 32696, 32692, 32689, 32685, 32682, 32678, 32674, 32671, 32667, 32663, 32659, 32655, 32650, 32646, 32642, 32637, 32633, 32628, 32624, 32619, 32614, 32609, 32604, 32599, 32594, 32589, 32584, 32578, 32573, 32567, 32562, 32556, 32550, 32545, 32539, 32533, 32527, 32521, 32514, 32508, 32502, 32495, 32489, 32482, 32476, 32469, 32462, 32455, 32448, 32441, 32434, 32427, 32420, 32412, 32405, 32397, 32390, 32382, 32375, 32367, 32359, 32351, 32343, 32335, 32327, 32318, 32310, 32302, 32293, 32285, 32276, 32267, 32258, 32250, 32241, 32232, 32223, 32213, 32204, 32195, 32185, 32176, 32166, 32157, 32147, 32137, 32128, 32118, 32108, 32098, 32087, 32077, 32067, 32057, 32046, 32036, 32025, 32014, 32004, 31993, 31982, 31971, 31960, 31949, 31937, 31926, 31915, 31903, 31892, 31880, 31869, 31857, 31845, 31833, 31821, 31809, 31797, 31785, 31773, 31760, 31748, 31736, 31723, 31710, 31698, 31685, 31672, 31659, 31646, 31633, 31620, 31607, 31593, 31580, 31567, 31553, 31539, 31526, 31512, 31498, 31484, 31470, 31456, 31442, 31428, 31414, 31400, 31385, 31371, 31356, 31341, 31327, 31312, 31297, 31282, 31267, 31252, 31237, 31222, 31206, 31191, 31176, 31160, 31145, 31129, 31113, 31097, 31082, 31066, 31050, 31033, 31017, 31001, 30985, 30968, 30952, 30935, 30919, 30902, 30885, 30868, 30852, 30835, 30818, 30800, 30783, 30766, 30749, 30731, 30714, 30696, 30679, 30661, 30643, 30625, 30607, 30589, 30571, 30553, 30535, 30517, 30498, 30480, 30462, 30443, 30424, 30406, 30387, 30368, 30349, 30330, 30311, 30292, 30273, 30253, 30234, 30215, 30195, 30176, 30156, 30136, 30117, 30097, 30077, 30057, 30037, 30017, 29997, 29976, 29956, 29936, 29915, 29894, 29874, 29853, 29832, 29812, 29791, 29770, 29749, 29728, 29706, 29685, 29664, 29642, 29621, 29599, 29578, 29556, 29534, 29513, 29491, 29469, 29447, 29425, 29403, 29380, 29358, 29336, 29313, 29291, 29268, 29246, 29223, 29200, 29177, 29154, 29131, 29108, 29085, 29062, 29039, 29016, 28992, 28969, 28945, 28922, 28898, 28874, 28850, 28827, 28803, 28779, 28755, 28730, 28706, 28682, 28658, 28633, 28609, 28584, 28560, 28535, 28510, 28485, 28460, 28436, 28411, 28385, 28360, 28335, 28310, 28284, 28259, 28234, 28208, 28182, 28157, 28131, 28105, 28079, 28053, 28027, 28001, 27975, 27949, 27923, 27896, 27870, 27843, 27817, 27790, 27764, 27737, 27710, 27683, 27656, 27629, 27602, 27575, 27548, 27521, 27493, 27466, 27439, 27411, 27384, 27356, 27328, 27300, 27273, 27245, 27217, 27189, 27161, 27133, 27104, 27076, 27048, 27019, 26991, 26962, 26934, 26905, 26876, 26848, 26819, 26790, 26761, 26732, 26703, 26674, 26644, 26615, 26586, 26556, 26527, 26497, 26468, 26438, 26408, 26378, 26349, 26319, 26289, 26259, 26229, 26198, 26168, 26138, 26108, 26077, 26047, 26016, 25986, 25955, 25924, 25893, 25863, 25832, 25801, 25770, 25739, 25708, 25676, 25645, 25614, 25582, 25551, 25519, 25488, 25456, 25425, 25393, 25361, 25329, 25297, 25265, 25233, 25201, 25169, 25137, 25105, 25072, 25040, 25007, 24975, 24942, 24910, 24877, 24844, 24811, 24779, 24746, 24713, 24680, 24647, 24613, 24580, 24547, 24514, 24480, 24447, 24413, 24380, 24346, 24312, 24279, 24245, 24211, 24177, 24143, 24109, 24075, 24041, 24007, 23973, 23938, 23904, 23870, 23835, 23801, 23766, 23731, 23697, 23662, 23627, 23592, 23557, 23522, 23487, 23452, 23417, 23382, 23347, 23311, 23276, 23241, 23205, 23170, 23134, 23099, 23063, 23027, 22991, 22956, 22920, 22884, 22848, 22812, 22776, 22739, 22703, 22667, 22631, 22594, 22558, 22521, 22485, 22448, 22411, 22375, 22338, 22301, 22264, 22227, 22191, 22154, 22116, 22079, 22042, 22005, 21968, 21930, 21893, 21856, 21818, 21781, 21743, 21705, 21668, 21630, 21592, 21554, 21516, 21479, 21441, 21403, 21364, 21326, 21288, 21250, 21212, 21173, 21135, 21096, 21058, 21019, 20981, 20942, 20904, 20865, 20826, 20787, 20748, 20709, 20670, 20631, 20592, 20553, 20514, 20475, 20436, 20396, 20357, 20317, 20278, 20238, 20199, 20159, 20120, 20080, 20040, 20000, 19961, 19921, 19881, 19841, 19801, 19761, 19721, 19680, 19640, 19600, 19560, 19519, 19479, 19438, 19398, 19357, 19317, 19276, 19236, 19195, 19154, 19113, 19072, 19032, 18991, 18950, 18909, 18868, 18826, 18785, 18744, 18703, 18661, 18620, 18579, 18537, 18496, 18454, 18413, 18371, 18330, 18288, 18246, 18204, 18163, 18121, 18079, 18037, 17995, 17953, 17911, 17869, 17827, 17784, 17742, 17700, 17657, 17615, 17573, 17530, 17488, 17445, 17403, 17360, 17317, 17275, 17232, 17189, 17146, 17104, 17061, 17018, 16975, 16932, 16889, 16846, 16802, 16759, 16716, 16673, 16630, 16586, 16543, 16499, 16456, 16413, 16369, 16325, 16282, 16238, 16195, 16151, 16107, 16063, 16019, 15976, 15932, 15888, 15844, 15800, 15756, 15712, 15667, 15623, 15579, 15535, 15491, 15446, 15402, 15358, 15313, 15269, 15224, 15180, 15135, 15090, 15046, 15001, 14956, 14912, 14867, 14822, 14777, 14732, 14688, 14643, 14598, 14553, 14507, 14462, 14417, 14372, 14327, 14282, 14236, 14191, 14146, 14101, 14055, 14010, 13964, 13919, 13873, 13828, 13782, 13736, 13691, 13645, 13599, 13554, 13508, 13462, 13416, 13370, 13324, 13279, 13233, 13187, 13141, 13094, 13048, 13002, 12956, 12910, 12864, 12817, 12771, 12725, 12679, 12632, 12586, 12539, 12493, 12446, 12400, 12353, 12307, 12260, 12214, 12167, 12120, 12074, 12027, 11980, 11933, 11886, 11840, 11793, 11746, 11699, 11652, 11605, 11558, 11511, 11464, 11417, 11370, 11322, 11275, 11228, 11181, 11133, 11086, 11039, 10992, 10944, 10897, 10849, 10802, 10754, 10707, 10659, 10612, 10564, 10517, 10469, 10421, 10374, 10326, 10278, 10231, 10183, 10135, 10087, 10039, 9992, 9944, 9896, 9848, 9800, 9752, 9704, 9656, 9608, 9560, 9512, 9464, 9416, 9367, 9319, 9271, 9223, 9175, 9126, 9078, 9030, 8981, 8933, 8885, 8836, 8788, 8739, 8691, 8642, 8594, 8545, 8497, 8448, 8400, 8351, 8303, 8254, 8205, 8157, 8108, 8059, 8010, 7962, 7913, 7864, 7815, 7767, 7718, 7669, 7620, 7571, 7522, 7473, 7424, 7375, 7326, 7277, 7228, 7179, 7130, 7081, 7032, 6983, 6934, 6885, 6836, 6786, 6737, 6688, 6639, 6590, 6540, 6491, 6442, 6393, 6343, 6294, 6245, 6195, 6146, 6096, 6047, 5998, 5948, 5899, 5849, 5800, 5750, 5701, 5651, 5602, 5552, 5503, 5453, 5404, 5354, 5305, 5255, 5205, 5156, 5106, 5056, 5007, 4957, 4907, 4858, 4808, 4758, 4708, 4659, 4609, 4559, 4509, 4460, 4410, 4360, 4310, 4260, 4210, 4161, 4111, 4061, 4011, 3961, 3911, 3861, 3811, 3761, 3712, 3662, 3612, 3562, 3512, 3462, 3412, 3362, 3312, 3262, 3212, 3162, 3112, 3062, 3012, 2962, 2911, 2861, 2811, 2761, 2711, 2661, 2611, 2561, 2511, 2461, 2410, 2360, 2310, 2260, 2210, 2160, 2110, 2059, 2009, 1959, 1909, 1859, 1809, 1758, 1708, 1658, 1608, 1558, 1507, 1457, 1407, 1357, 1307, 1256, 1206, 1156, 1106, 1055, 1005, 955, 905, 854, 804, 754, 704, 653, 603, 553, 503, 452, 402, 352, 302, 251, 201, 151, 101, 50, 0, -50, -101, -151, -201, -251, -302, -352, -402, -452, -503, -553, -603, -653, -704, -754, -804, -854, -905, -955, -1005, -1055, -1106, -1156, -1206, -1256, -1307, -1357, -1407, -1457, -1507, -1558, -1608, -1658, -1708, -1758, -1809, -1859, -1909, -1959, -2009, -2059, -2110, -2160, -2210, -2260, -2310, -2360, -2410, -2461, -2511, -2561, -2611, -2661, -2711, -2761, -2811, -2861, -2911, -2962, -3012, -3062, -3112, -3162, -3212, -3262, -3312, -3362, -3412, -3462, -3512, -3562, -3612, -3662, -3712, -3761, -3811, -3861, -3911, -3961, -4011, -4061, -4111, -4161, -4210, -4260, -4310, -4360, -4410, -4460, -4509, -4559, -4609, -4659, -4708, -4758, -4808, -4858, -4907, -4957, -5007, -5056, -5106, -5156, -5205, -5255, -5305, -5354, -5404, -5453, -5503, -5552, -5602, -5651, -5701, -5750, -5800, -5849, -5899, -5948, -5998, -6047, -6096, -6146, -6195, -6245, -6294, -6343, -6393, -6442, -6491, -6540, -6590, -6639, -6688, -6737, -6786, -6836, -6885, -6934, -6983, -7032, -7081, -7130, -7179, -7228, -7277, -7326, -7375, -7424, -7473, -7522, -7571, -7620, -7669, -7718, -7767, -7815, -7864, -7913, -7962, -8010, -8059, -8108, -8157, -8205, -8254, -8303, -8351, -8400, -8448, -8497, -8545, -8594, -8642, -8691, -8739, -8788, -8836, -8885, -8933, -8981, -9030, -9078, -9126, -9175, -9223, -9271, -9319, -9367, -9416, -9464, -9512, -9560, -9608, -9656, -9704, -9752, -9800, -9848, -9896, -9944, -9992, -10039, -10087, -10135, -10183, -10231, -10278, -10326, -10374, -10421, -10469, -10517, -10564, -10612, -10659, -10707, -10754, -10802, -10849, -10897, -10944, -10992, -11039, -11086, -11133, -11181, -11228, -11275, -11322, -11370, -11417, -11464, -11511, -11558, -11605, -11652, -11699, -11746, -11793, -11840, -11886, -11933, -11980, -12027, -12074, -12120, -12167, -12214, -12260, -12307, -12353, -12400, -12446, -12493, -12539, -12586, -12632, -12679, -12725, -12771, -12817, -12864, -12910, -12956, -13002, -13048, -13094, -13141, -13187, -13233, -13279, -13324, -13370, -13416, -13462, -13508, -13554, -13599, -13645, -13691, -13736, -13782, -13828, -13873, -13919, -13964, -14010, -14055, -14101, -14146, -14191, -14236, -14282, -14327, -14372, -14417, -14462, -14507, -14553, -14598, -14643, -14688, -14732, -14777, -14822, -14867, -14912, -14956, -15001, -15046, -15090, -15135, -15180, -15224, -15269, -15313, -15358, -15402, -15446, -15491, -15535, -15579, -15623, -15667, -15712, -15756, -15800, -15844, -15888, -15932, -15976, -16019, -16063, -16107, -16151, -16195, -16238, -16282, -16325, -16369, -16413, -16456, -16499, -16543, -16586, -16630, -16673, -16716, -16759, -16802, -16846, -16889, -16932, -16975, -17018, -17061, -17104, -17146, -17189, -17232, -17275, -17317, -17360, -17403, -17445, -17488, -17530, -17573, -17615, -17657, -17700, -17742, -17784, -17827, -17869, -17911, -17953, -17995, -18037, -18079, -18121, -18163, -18204, -18246, -18288, -18330, -18371, -18413, -18454, -18496, -18537, -18579, -18620, -18661, -18703, -18744, -18785, -18826, -18868, -18909, -18950, -18991, -19032, -19072, -19113, -19154, -19195, -19236, -19276, -19317, -19357, -19398, -19438, -19479, -19519, -19560, -19600, -19640, -19680, -19721, -19761, -19801, -19841, -19881, -19921, -19961, -20000, -20040, -20080, -20120, -20159, -20199, -20238, -20278, -20317, -20357, -20396, -20436, -20475, -20514, -20553, -20592, -20631, -20670, -20709, -20748, -20787, -20826, -20865, -20904, -20942, -20981, -21019, -21058, -21096, -21135, -21173, -21212, -21250, -21288, -21326, -21364, -21403, -21441, -21479, -21516, -21554, -21592, -21630, -21668, -21705, -21743, -21781, -21818, -21856, -21893, -21930, -21968, -22005, -22042, -22079, -22116, -22154, -22191, -22227, -22264, -22301, -22338, -22375, -22411, -22448, -22485, -22521, -22558, -22594, -22631, -22667, -22703, -22739, -22776, -22812, -22848, -22884, -22920, -22956, -22991, -23027, -23063, -23099, -23134, -23170, -23205, -23241, -23276, -23311, -23347, -23382, -23417, -23452, -23487, -23522, -23557, -23592, -23627, -23662, -23697, -23731, -23766, -23801, -23835, -23870, -23904, -23938, -23973, -24007, -24041, -24075, -24109, -24143, -24177, -24211, -24245, -24279, -24312, -24346, -24380, -24413, -24447, -24480, -24514, -24547, -24580, -24613, -24647, -24680, -24713, -24746, -24779, -24811, -24844, -24877, -24910, -24942, -24975, -25007, -25040, -25072, -25105, -25137, -25169, -25201, -25233, -25265, -25297, -25329, -25361, -25393, -25425, -25456, -25488, -25519, -25551, -25582, -25614, -25645, -25676, -25708, -25739, -25770, -25801, -25832, -25863, -25893, -25924, -25955, -25986, -26016, -26047, -26077, -26108, -26138, -26168, -26198, -26229, -26259, -26289, -26319, -26349, -26378, -26408, -26438, -26468, -26497, -26527, -26556, -26586, -26615, -26644, -26674, -26703, -26732, -26761, -26790, -26819, -26848, -26876, -26905, -26934, -26962, -26991, -27019, -27048, -27076, -27104, -27133, -27161, -27189, -27217, -27245, -27273, -27300, -27328, -27356, -27384, -27411, -27439, -27466, -27493, -27521, -27548, -27575, -27602, -27629, -27656, -27683, -27710, -27737, -27764, -27790, -27817, -27843, -27870, -27896, -27923, -27949, -27975, -28001, -28027, -28053, -28079, -28105, -28131, -28157, -28182, -28208, -28234, -28259, -28284, -28310, -28335, -28360, -28385, -28411, -28436, -28460, -28485, -28510, -28535, -28560, -28584, -28609, -28633, -28658, -28682, -28706, -28730, -28755, -28779, -28803, -28827, -28850, -28874, -28898, -28922, -28945, -28969, -28992, -29016, -29039, -29062, -29085, -29108, -29131, -29154, -29177, -29200, -29223, -29246, -29268, -29291, -29313, -29336, -29358, -29380, -29403, -29425, -29447, -29469, -29491, -29513, -29534, -29556, -29578, -29599, -29621, -29642, -29664, -29685, -29706, -29728, -29749, -29770, -29791, -29812, -29832, -29853, -29874, -29894, -29915, -29936, -29956, -29976, -29997, -30017, -30037, -30057, -30077, -30097, -30117, -30136, -30156, -30176, -30195, -30215, -30234, -30253, -30273, -30292, -30311, -30330, -30349, -30368, -30387, -30406, -30424, -30443, -30462, -30480, -30498, -30517, -30535, -30553, -30571, -30589, -30607, -30625, -30643, -30661, -30679, -30696, -30714, -30731, -30749, -30766, -30783, -30800, -30818, -30835, -30852, -30868, -30885, -30902, -30919, -30935, -30952, -30968, -30985, -31001, -31017, -31033, -31050, -31066, -31082, -31097, -31113, -31129, -31145, -31160, -31176, -31191, -31206, -31222, -31237, -31252, -31267, -31282, -31297, -31312, -31327, -31341, -31356, -31371, -31385, -31400, -31414, -31428, -31442, -31456, -31470, -31484, -31498, -31512, -31526, -31539, -31553, -31567, -31580, -31593, -31607, -31620, -31633, -31646, -31659, -31672, -31685, -31698, -31710, -31723, -31736, -31748, -31760, -31773, -31785, -31797, -31809, -31821, -31833, -31845, -31857, -31869, -31880, -31892, -31903, -31915, -31926, -31937, -31949, -31960, -31971, -31982, -31993, -32004, -32014, -32025, -32036, -32046, -32057, -32067, -32077, -32087, -32098, -32108, -32118, -32128, -32137, -32147, -32157, -32166, -32176, -32185, -32195, -32204, -32213, -32223, -32232, -32241, -32250, -32258, -32267, -32276, -32285, -32293, -32302, -32310, -32318, -32327, -32335, -32343, -32351, -32359, -32367, -32375, -32382, -32390, -32397, -32405, -32412, -32420, -32427, -32434, -32441, -32448, -32455, -32462, -32469, -32476, -32482, -32489, -32495, -32502, -32508, -32514, -32521, -32527, -32533, -32539, -32545, -32550, -32556, -32562, -32567, -32573, -32578, -32584, -32589, -32594, -32599, -32604, -32609, -32614, -32619, -32624, -32628, -32633, -32637, -32642, -32646, -32650, -32655, -32659, -32663, -32667, -32671, -32674, -32678, -32682, -32685, -32689, -32692, -32696, -32699, -32702, -32705, -32708, -32711, -32714, -32717, -32720, -32722, -32725, -32728, -32730, -32732, -32735, -32737, -32739, -32741, -32743, -32745, -32747, -32748, -32750, -32752, -32753, -32755, -32756, -32757, -32758, -32759, -32760, -32761, -32762, -32763, -32764, -32765, -32765, -32766, -32766, -32766, -32767, -32767, -32767, -32767, -32767, -32767, -32767, -32766, -32766, -32766, -32765, -32765, -32764, -32763, -32762, -32761, -32760, -32759, -32758, -32757, -32756, -32755, -32753, -32752, -32750, -32748, -32747, -32745, -32743, -32741, -32739, -32737, -32735, -32732, -32730, -32728, -32725, -32722, -32720, -32717, -32714, -32711, -32708, -32705, -32702, -32699, -32696, -32692, -32689, -32685, -32682, -32678, -32674, -32671, -32667, -32663, -32659, -32655, -32650, -32646, -32642, -32637, -32633, -32628, -32624, -32619, -32614, -32609, -32604, -32599, -32594, -32589, -32584, -32578, -32573, -32567, -32562, -32556, -32550, -32545, -32539, -32533, -32527, -32521, -32514, -32508, -32502, -32495, -32489, -32482, -32476, -32469, -32462, -32455, -32448, -32441, -32434, -32427, -32420, -32412, -32405, -32397, -32390, -32382, -32375, -32367, -32359, -32351, -32343, -32335, -32327, -32318, -32310, -32302, -32293, -32285, -32276, -32267, -32258, -32250, -32241, -32232, -32223, -32213, -32204, -32195, -32185, -32176, -32166, -32157, -32147, -32137, -32128, -32118, -32108, -32098, -32087, -32077, -32067, -32057, -32046, -32036, -32025, -32014, -32004, -31993, -31982, -31971, -31960, -31949, -31937, -31926, -31915, -31903, -31892, -31880, -31869, -31857, -31845, -31833, -31821, -31809, -31797, -31785, -31773, -31760, -31748, -31736, -31723, -31710, -31698, -31685, -31672, -31659, -31646, -31633, -31620, -31607, -31593, -31580, -31567, -31553, -31539, -31526, -31512, -31498, -31484, -31470, -31456, -31442, -31428, -31414, -31400, -31385, -31371, -31356, -31341, -31327, -31312, -31297, -31282, -31267, -31252, -31237, -31222, -31206, -31191, -31176, -31160, -31145, -31129, -31113, -31097, -31082, -31066, -31050, -31033, -31017, -31001, -30985, -30968, -30952, -30935, -30919, -30902, -30885, -30868, -30852, -30835, -30818, -30800, -30783, -30766, -30749, -30731, -30714, -30696, -30679, -30661, -30643, -30625, -30607, -30589, -30571, -30553, -30535, -30517, -30498, -30480, -30462, -30443, -30424, -30406, -30387, -30368, -30349, -30330, -30311, -30292, -30273, -30253, -30234, -30215, -30195, -30176, -30156, -30136, -30117, -30097, -30077, -30057, -30037, -30017, -29997, -29976, -29956, -29936, -29915, -29894, -29874, -29853, -29832, -29812, -29791, -29770, -29749, -29728, -29706, -29685, -29664, -29642, -29621, -29599, -29578, -29556, -29534, -29513, -29491, -29469, -29447, -29425, -29403, -29380, -29358, -29336, -29313, -29291, -29268, -29246, -29223, -29200, -29177, -29154, -29131, -29108, -29085, -29062, -29039, -29016, -28992, -28969, -28945, -28922, -28898, -28874, -28850, -28827, -28803, -28779, -28755, -28730, -28706, -28682, -28658, -28633, -28609, -28584, -28560, -28535, -28510, -28485, -28460, -28436, -28411, -28385, -28360, -28335, -28310, -28284, -28259, -28234, -28208, -28182, -28157, -28131, -28105, -28079, -28053, -28027, -28001, -27975, -27949, -27923, -27896, -27870, -27843, -27817, -27790, -27764, -27737, -27710, -27683, -27656, -27629, -27602, -27575, -27548, -27521, -27493, -27466, -27439, -27411, -27384, -27356, -27328, -27300, -27273, -27245, -27217, -27189, -27161, -27133, -27104, -27076, -27048, -27019, -26991, -26962, -26934, -26905, -26876, -26848, -26819, -26790, -26761, -26732, -26703, -26674, -26644, -26615, -26586, -26556, -26527, -26497, -26468, -26438, -26408, -26378, -26349, -26319, -26289, -26259, -26229, -26198, -26168, -26138, -26108, -26077, -26047, -26016, -25986, -25955, -25924, -25893, -25863, -25832, -25801, -25770, -25739, -25708, -25676, -25645, -25614, -25582, -25551, -25519, -25488, -25456, -25425, -25393, -25361, -25329, -25297, -25265, -25233, -25201, -25169, -25137, -25105, -25072, -25040, -25007, -24975, -24942, -24910, -24877, -24844, -24811, -24779, -24746, -24713, -24680, -24647, -24613, -24580, -24547, -24514, -24480, -24447, -24413, -24380, -24346, -24312, -24279, -24245, -24211, -24177, -24143, -24109, -24075, -24041, -24007, -23973, -23938, -23904, -23870, -23835, -23801, -23766, -23731, -23697, -23662, -23627, -23592, -23557, -23522, -23487, -23452, -23417, -23382, -23347, -23311, -23276, -23241, -23205, -23170, -23134, -23099, -23063, -23027, -22991, -22956, -22920, -22884, -22848, -22812, -22776, -22739, -22703, -22667, -22631, -22594, -22558, -22521, -22485, -22448, -22411, -22375, -22338, -22301, -22264, -22227, -22191, -22154, -22116, -22079, -22042, -22005, -21968, -21930, -21893, -21856, -21818, -21781, -21743, -21705, -21668, -21630, -21592, -21554, -21516, -21479, -21441, -21403, -21364, -21326, -21288, -21250, -21212, -21173, -21135, -21096, -21058, -21019, -20981, -20942, -20904, -20865, -20826, -20787, -20748, -20709, -20670, -20631, -20592, -20553, -20514, -20475, -20436, -20396, -20357, -20317, -20278, -20238, -20199, -20159, -20120, -20080, -20040, -20000, -19961, -19921, -19881, -19841, -19801, -19761, -19721, -19680, -19640, -19600, -19560, -19519, -19479, -19438, -19398, -19357, -19317, -19276, -19236, -19195, -19154, -19113, -19072, -19032, -18991, -18950, -18909, -18868, -18826, -18785, -18744, -18703, -18661, -18620, -18579, -18537, -18496, -18454, -18413, -18371, -18330, -18288, -18246, -18204, -18163, -18121, -18079, -18037, -17995, -17953, -17911, -17869, -17827, -17784, -17742, -17700, -17657, -17615, -17573, -17530, -17488, -17445, -17403, -17360, -17317, -17275, -17232, -17189, -17146, -17104, -17061, -17018, -16975, -16932, -16889, -16846, -16802, -16759, -16716, -16673, -16630, -16586, -16543, -16499, -16456, -16413, -16369, -16325, -16282, -16238, -16195, -16151, -16107, -16063, -16019, -15976, -15932, -15888, -15844, -15800, -15756, -15712, -15667, -15623, -15579, -15535, -15491, -15446, -15402, -15358, -15313, -15269, -15224, -15180, -15135, -15090, -15046, -15001, -14956, -14912, -14867, -14822, -14777, -14732, -14688, -14643, -14598, -14553, -14507, -14462, -14417, -14372, -14327, -14282, -14236, -14191, -14146, -14101, -14055, -14010, -13964, -13919, -13873, -13828, -13782, -13736, -13691, -13645, -13599, -13554, -13508, -13462, -13416, -13370, -13324, -13279, -13233, -13187, -13141, -13094, -13048, -13002, -12956, -12910, -12864, -12817, -12771, -12725, -12679, -12632, -12586, -12539, -12493, -12446, -12400, -12353, -12307, -12260, -12214, -12167, -12120, -12074, -12027, -11980, -11933, -11886, -11840, -11793, -11746, -11699, -11652, -11605, -11558, -11511, -11464, -11417, -11370, -11322, -11275, -11228, -11181, -11133, -11086, -11039, -10992, -10944, -10897, -10849, -10802, -10754, -10707, -10659, -10612, -10564, -10517, -10469, -10421, -10374, -10326, -10278, -10231, -10183, -10135, -10087, -10039, -9992, -9944, -9896, -9848, -9800, -9752, -9704, -9656, -9608, -9560, -9512, -9464, -9416, -9367, -9319, -9271, -9223, -9175, -9126, -9078, -9030, -8981, -8933, -8885, -8836, -8788, -8739, -8691, -8642, -8594, -8545, -8497, -8448, -8400, -8351, -8303, -8254, -8205, -8157, -8108, -8059, -8010, -7962, -7913, -7864, -7815, -7767, -7718, -7669, -7620, -7571, -7522, -7473, -7424, -7375, -7326, -7277, -7228, -7179, -7130, -7081, -7032, -6983, -6934, -6885, -6836, -6786, -6737, -6688, -6639, -6590, -6540, -6491, -6442, -6393, -6343, -6294, -6245, -6195, -6146, -6096, -6047, -5998, -5948, -5899, -5849, -5800, -5750, -5701, -5651, -5602, -5552, -5503, -5453, -5404, -5354, -5305, -5255, -5205, -5156, -5106, -5056, -5007, -4957, -4907, -4858, -4808, -4758, -4708, -4659, -4609, -4559, -4509, -4460, -4410, -4360, -4310, -4260, -4210, -4161, -4111, -4061, -4011, -3961, -3911, -3861, -3811, -3761, -3712, -3662, -3612, -3562, -3512, -3462, -3412, -3362, -3312, -3262, -3212, -3162, -3112, -3062, -3012, -2962, -2911, -2861, -2811, -2761, -2711, -2661, -2611, -2561, -2511, -2461, -2410, -2360, -2310, -2260, -2210, -2160, -2110, -2059, -2009, -1959, -1909, -1859, -1809, -1758, -1708, -1658, -1608, -1558, -1507, -1457, -1407, -1357, -1307, -1256, -1206, -1156, -1106, -1055, -1005, -955, -905, -854, -804, -754, -704, -653, -603, -553, -503, -452, -402, -352, -302, -251, -201, -151, -101, -50};

const uint8_t PanTable[PANTABLE_NUM]
					   ={0, 11, 16, 20, 23, 25, 28, 30, 32, 34, 36, 37, 39, 41, 42, 44, 45, 46, 48, 49, 50, 52, 53, 54, 55, 56, 57, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 69, 70, 71, 72, 73, 74, 75, 76, 76, 77, 78, 79, 80, 80, 81, 82, 83, 84, 84, 85, 86, 87, 87, 88, 89, 89, 90, 91, 92, 92, 93, 94, 94, 95, 96, 96, 97, 98, 98, 99, 100, 100, 101, 101, 102, 103, 103, 104, 105, 105, 106, 106, 107, 108, 108, 109, 109, 110, 110, 111, 112, 112, 113, 113, 114, 114, 115, 115, 116, 117, 117, 118, 118, 119, 119, 120, 120, 121, 121, 122, 122, 123, 123, 124, 124, 125, 125, 126, 126, 127};

const float ModTable[MODTABLE_NUM]
					 ={0.00000000000, 0.00001149053, 0.00002297414, 0.00003444391, 0.00004589293, 0.00005731431, 0.00006870117, 0.00008004664, 0.00009134389, 0.00010258612, 0.00011376656, 0.00012487847, 0.00013591516, 0.00014686998, 0.00015773632, 0.00016850766, 0.00017917749, 0.00018973939, 0.00020018700, 0.00021051402, 0.00022071424, 0.00023078151, 0.00024070976, 0.00025049302, 0.00026012540, 0.00026960108, 0.00027891436, 0.00028805964, 0.00029703140, 0.00030582424, 0.00031443286, 0.00032285208, 0.00033107683, 0.00033910215, 0.00034692320, 0.00035453528, 0.00036193381, 0.00036911432, 0.00037607248, 0.00038280412, 0.00038930517, 0.00039557171, 0.00040159998, 0.00040738634, 0.00041292730, 0.00041821953, 0.00042325985, 0.00042804520, 0.00043257272, 0.00043683968, 0.00044084349, 0.00044458176, 0.00044805223, 0.00045125281, 0.00045418157, 0.00045683675, 0.00045921675, 0.00046132014, 0.00046314564, 0.00046469216, 0.00046595877, 0.00046694470, 0.00046764936, 0.00046807232, 0.00046821334, 0.00046807232, 0.00046764936, 0.00046694470, 0.00046595877, 0.00046469216, 0.00046314564, 0.00046132014, 0.00045921675, 0.00045683675, 0.00045418157, 0.00045125281, 0.00044805223, 0.00044458176, 0.00044084349, 0.00043683968, 0.00043257272, 0.00042804520, 0.00042325985, 0.00041821953, 0.00041292730, 0.00040738634, 0.00040159998, 0.00039557171, 0.00038930517, 0.00038280412, 0.00037607248, 0.00036911432, 0.00036193381, 0.00035453528, 0.00034692320, 0.00033910215, 0.00033107683, 0.00032285208, 0.00031443286, 0.00030582424, 0.00029703140, 0.00028805964, 0.00027891436, 0.00026960108, 0.00026012540, 0.00025049302, 0.00024070976, 0.00023078151, 0.00022071424, 0.00021051402, 0.00020018700, 0.00018973939, 0.00017917749, 0.00016850766, 0.00015773632, 0.00014686998, 0.00013591516, 0.00012487847, 0.00011376656, 0.00010258612, 0.00009134389, 0.00008004664, 0.00006870117, 0.00005731431, 0.00004589293, 0.00003444391, 0.00002297414, 0.00001149053, 0.00000000000, -0.00001149053, -0.00002297414, -0.00003444391, -0.00004589293, -0.00005731431, -0.00006870117, -0.00008004664, -0.00009134389, -0.00010258612, -0.00011376656, -0.00012487847, -0.00013591516, -0.00014686998, -0.00015773632, -0.00016850766, -0.00017917749, -0.00018973939, -0.00020018700, -0.00021051402, -0.00022071424, -0.00023078151, -0.00024070976, -0.00025049302, -0.00026012540, -0.00026960108, -0.00027891436, -0.00028805964, -0.00029703140, -0.00030582424, -0.00031443286, -0.00032285208, -0.00033107683, -0.00033910215, -0.00034692320, -0.00035453528, -0.00036193381, -0.00036911432, -0.00037607248, -0.00038280412, -0.00038930517, -0.00039557171, -0.00040159998, -0.00040738634, -0.00041292730, -0.00041821953, -0.00042325985, -0.00042804520, -0.00043257272, -0.00043683968, -0.00044084349, -0.00044458176, -0.00044805223, -0.00045125281, -0.00045418157, -0.00045683675, -0.00045921675, -0.00046132014, -0.00046314564, -0.00046469216, -0.00046595877, -0.00046694470, -0.00046764936, -0.00046807232, -0.00046821334, -0.00046807232, -0.00046764936, -0.00046694470, -0.00046595877, -0.00046469216, -0.00046314564, -0.00046132014, -0.00045921675, -0.00045683675, -0.00045418157, -0.00045125281, -0.00044805223, -0.00044458176, -0.00044084349, -0.00043683968, -0.00043257272, -0.00042804520, -0.00042325985, -0.00041821953, -0.00041292730, -0.00040738634, -0.00040159998, -0.00039557171, -0.00038930517, -0.00038280412, -0.00037607248, -0.00036911432, -0.00036193381, -0.00035453528, -0.00034692320, -0.00033910215, -0.00033107683, -0.00032285208, -0.00031443286, -0.00030582424, -0.00029703140, -0.00028805964, -0.00027891436, -0.00026960108, -0.00026012540, -0.00025049302, -0.00024070976, -0.00023078151, -0.00022071424, -0.00021051402, -0.00020018700, -0.00018973939, -0.00017917749, -0.00016850766, -0.00015773632, -0.00014686998, -0.00013591516, -0.00012487847, -0.00011376656, -0.00010258612, -0.00009134389, -0.00008004664, -0.00006870117, -0.00005731431, -0.00004589293, -0.00003444391, -0.00002297414, -0.00001149053};

const float PitchbendTable[PITCHTABLE_NUM]
						   ={1, 1.000902943, 1.001806701, 1.002711275, 1.003616666, 1.004522874, 1.005429901, 1.006337747, 1.007246412, 1.008155898, 1.009066205, 1.009977334, 1.010889286, 1.011802061, 1.012715661, 1.013630085, 1.014545335, 1.015461411, 1.016378315, 1.017296046, 1.018214607, 1.019133996, 1.020054216, 1.020975266, 1.021897149, 1.022819863, 1.023743411, 1.024667793, 1.025593009, 1.026519061, 1.027445949, 1.028373674, 1.029302237, 1.030231638, 1.031161878, 1.032092958, 1.033024879, 1.033957641, 1.034891246, 1.035825694, 1.036760985, 1.037697121, 1.038634102, 1.039571929, 1.040510603, 1.041450125, 1.042390495, 1.043331714, 1.044273782, 1.045216702, 1.046160473, 1.047105096, 1.048050572, 1.048996902, 1.049944086, 1.050892125, 1.051841021, 1.052790773, 1.053741383, 1.054692851, 1.055645178, 1.056598366, 1.057552413, 1.058507323, 1.059463094, 1.060419729, 1.061377227, 1.06233559, 1.063294818, 1.064254913, 1.065215874, 1.066177703, 1.067140401, 1.068103967, 1.069068404, 1.070033712, 1.070999891, 1.071966943, 1.072934868, 1.073903666, 1.07487334, 1.075843889, 1.076815315, 1.077787617, 1.078760798, 1.079734857, 1.080709796, 1.081685615, 1.082662315, 1.083639897, 1.084618362, 1.085597711, 1.086577943, 1.087559061, 1.088541065, 1.089523955, 1.090507733, 1.091492399, 1.092477954, 1.093464399, 1.094451735, 1.095439962, 1.096429082, 1.097419095, 1.098410001, 1.099401803, 1.1003945, 1.101388093, 1.102382583, 1.103377972, 1.104374259, 1.105371446, 1.106369533, 1.107368521, 1.108368412, 1.109369205, 1.110370902, 1.111373503, 1.11237701, 1.113381423, 1.114386743, 1.11539297, 1.116400106, 1.117408152, 1.118417107, 1.119426974, 1.120437752, 1.121449444, 1.122462048, 1.123475567, 1.124490002, 1.125505352, 1.126521619, 1.127538803, 1.128556906, 1.129575929, 1.130595871, 1.131616734, 1.13263852, 1.133661227, 1.134684859, 1.135709414, 1.136734895, 1.137761301, 1.138788635, 1.139816896, 1.140846085, 1.141876204, 1.142907253, 1.143939233, 1.144972144, 1.146005989, 1.147040767, 1.148076479, 1.149113126, 1.15015071, 1.15118923, 1.152228688, 1.153269085, 1.154310421, 1.155352697, 1.156395914, 1.157440074, 1.158485176, 1.159531222, 1.160578212, 1.161626148, 1.16267503, 1.163724859, 1.164775636, 1.165827362, 1.166880037, 1.167933663, 1.16898824, 1.17004377, 1.171100252, 1.172157689, 1.17321608, 1.174275427, 1.175335731, 1.176396992, 1.177459211, 1.178522389, 1.179586527, 1.180651627, 1.181717688, 1.182784711, 1.183852698, 1.184921649, 1.185991566, 1.187062448, 1.188134298, 1.189207115, 1.190280901, 1.191355657, 1.192431383, 1.19350808, 1.194585749, 1.195664392, 1.196744009, 1.1978246, 1.198906167, 1.199988711, 1.201072232, 1.202156731, 1.20324221, 1.204328669, 1.205416109, 1.206504531, 1.207593935, 1.208684324, 1.209775696, 1.210868055, 1.211961399, 1.213055731, 1.214151051, 1.21524736, 1.216344659, 1.217442948, 1.21854223, 1.219642504, 1.220743771, 1.221846033, 1.22294929, 1.224053543, 1.225158794, 1.226265042, 1.227372289, 1.228480536, 1.229589784, 1.230700033, 1.231811285, 1.23292354, 1.234036799, 1.235151064, 1.236266335, 1.237382612, 1.238499898, 1.239618193, 1.240737497, 1.241857812, 1.242979139, 1.244101478, 1.24522483, 1.246349197, 1.247474579, 1.248600977, 1.249728392, 1.250856826, 1.251986278, 1.25311675, 1.254248243, 1.255380757, 1.256514294, 1.257648855, 1.25878444, 1.25992105, 1.261058687, 1.26219735, 1.263337042, 1.264477763, 1.265619515, 1.266762297, 1.26790611, 1.269050957, 1.270196838, 1.271343753, 1.272491703, 1.273640691, 1.274790715, 1.275941778, 1.277093881, 1.278247024, 1.279401208, 1.280556434, 1.281712703, 1.282870016, 1.284028374, 1.285187778, 1.28634823, 1.287509728, 1.288672276, 1.289835873, 1.291000521, 1.292166221, 1.293332973, 1.294500779, 1.295669639, 1.296839555, 1.298010527, 1.299182556, 1.300355643, 1.30152979, 1.302704997, 1.303881265, 1.305058595, 1.306236989, 1.307416446, 1.308596968, 1.309778556, 1.310961212, 1.312144935, 1.313329726, 1.314515588, 1.31570252, 1.316890524, 1.318079601, 1.319269752, 1.320460977, 1.321653278, 1.322846655, 1.32404111, 1.325236643, 1.326433256, 1.327630949, 1.328829724, 1.330029581, 1.331230522, 1.332432547, 1.333635657, 1.334839854, 1.336045138, 1.337251511, 1.338458972, 1.339667524, 1.340877167, 1.342087903, 1.343299731, 1.344512654, 1.345726672, 1.346941786, 1.348157998, 1.349375307, 1.350593716, 1.351813225, 1.353033835, 1.354255547, 1.355478362, 1.356702282, 1.357927306, 1.359153437, 1.360380675, 1.361609021, 1.362838476, 1.364069041, 1.365300717, 1.366533506, 1.367767407, 1.369002423, 1.370238554, 1.371475801, 1.372714165, 1.373953647, 1.375194249, 1.376435971, 1.377678814, 1.378922779, 1.380167867, 1.38141408, 1.382661418, 1.383909882, 1.385159473, 1.386410193, 1.387662042, 1.388915022, 1.390169133, 1.391424376, 1.392680752, 1.393938263, 1.39519691, 1.396456693, 1.397717613, 1.398979673, 1.400242871, 1.40150721, 1.402772691, 1.404039315, 1.405307082, 1.406575994, 1.407846051, 1.409117256, 1.410389608, 1.411663109, 1.41293776, 1.414213562, 1.415490516, 1.416768623, 1.418047884, 1.4193283, 1.420609873, 1.421892602, 1.42317649, 1.424461537, 1.425747744, 1.427035113, 1.428323644, 1.429613338, 1.430904197, 1.432196222, 1.433489413, 1.434783772, 1.4360793, 1.437375997, 1.438673866, 1.439972906, 1.441273119, 1.442574506, 1.443877069, 1.445180807, 1.446485723, 1.447791816, 1.44909909, 1.450407543, 1.451717178, 1.453027996, 1.454339997, 1.455653183, 1.456967554, 1.458283113, 1.459599859, 1.460917794, 1.462236919, 1.463557236, 1.464878744, 1.466201446, 1.467525342, 1.468850433, 1.470176721, 1.471504207, 1.472832891, 1.474162775, 1.475493859, 1.476826146, 1.478159635, 1.479494329, 1.480830228, 1.482167333, 1.483505645, 1.484845166, 1.486185896, 1.487527837, 1.48887099, 1.490215355, 1.491560934, 1.492907728, 1.494255739, 1.495604966, 1.496955412, 1.498307077, 1.499659962, 1.50101407, 1.502369399, 1.503725953, 1.505083732, 1.506442736, 1.507802968, 1.509164428, 1.510527117, 1.511891036, 1.513256187, 1.514622571, 1.515990189, 1.517359041, 1.51872913, 1.520100455, 1.521473019, 1.522846822, 1.524221866, 1.525598151, 1.526975679, 1.52835445, 1.529734467, 1.53111573, 1.53249824, 1.533881998, 1.535267006, 1.536653264, 1.538040774, 1.539429537, 1.540819553, 1.542210825, 1.543603354, 1.544997139, 1.546392183, 1.547788487, 1.549186051, 1.550584878, 1.551984967, 1.553386321, 1.55478894, 1.556192825, 1.557597978, 1.5590044, 1.560412092, 1.561821055, 1.56323129, 1.564642798, 1.566055581, 1.56746964, 1.568884975, 1.570301589, 1.571719481, 1.573138654, 1.574559108, 1.575980845, 1.577403866, 1.578828171, 1.580253763, 1.581680641, 1.583108809, 1.584538265, 1.585969013, 1.587401052, 1.588834384, 1.590269011, 1.591704933, 1.593142151, 1.594580668, 1.596020483, 1.597461598, 1.598904014, 1.600347733, 1.601792756, 1.603239083, 1.604686716, 1.606135656, 1.607585905, 1.609037463, 1.610490332, 1.611944513, 1.613400006, 1.614856814, 1.616314938, 1.617774377, 1.619235135, 1.620697212, 1.622160609, 1.623625327, 1.625091368, 1.626558732, 1.628027422, 1.629497437, 1.63096878, 1.632441452, 1.633915453, 1.635390785, 1.63686745, 1.638345447, 1.63982478, 1.641305448, 1.642787453, 1.644270796, 1.645755478, 1.647241501, 1.648728866, 1.650217574, 1.651707626, 1.653199024, 1.654691768, 1.65618586, 1.657681301, 1.659178092, 1.660676235, 1.662175731, 1.66367658, 1.665178785, 1.666682346, 1.668187265, 1.669693543, 1.671201181, 1.67271018, 1.674220541, 1.675732267, 1.677245357, 1.678759814, 1.680275638, 1.681792831, 1.683311393, 1.684831327, 1.686352633, 1.687875313, 1.689399368, 1.690924799, 1.692451608, 1.693979795, 1.695509361, 1.697040309, 1.69857264, 1.700106354, 1.701641453, 1.703177937, 1.70471581, 1.706255071, 1.707795721, 1.709337763, 1.710881197, 1.712426025, 1.713972248, 1.715519867, 1.717068883, 1.718619298, 1.720171113, 1.721724329, 1.723278948, 1.72483497, 1.726392397, 1.727951231, 1.729511472, 1.731073122, 1.732636182, 1.734200653, 1.735766537, 1.737333835, 1.738902548, 1.740472678, 1.742044225, 1.743617191, 1.745191578, 1.746767386, 1.748344617, 1.749923272, 1.751503353, 1.75308486, 1.754667796, 1.75625216, 1.757837956, 1.759425183, 1.761013843, 1.762603938, 1.764195468, 1.765788436, 1.767382842, 1.768978687, 1.770575974, 1.772174703, 1.773774875, 1.775376493, 1.776979556, 1.778584067, 1.780190027, 1.781797436, 1.783406297, 1.785016611, 1.786628379, 1.788241602, 1.789856282, 1.79147242, 1.793090017, 1.794709075, 1.796329595, 1.797951578, 1.799575025, 1.801199938, 1.802826319, 1.804454168, 1.806083487, 1.807714277, 1.809346539, 1.810980276, 1.812615487, 1.814252176, 1.815890341, 1.817529987, 1.819171112, 1.82081372, 1.82245781, 1.824103385, 1.825750446, 1.827398995, 1.829049031, 1.830700558, 1.832353576, 1.834008086, 1.835664091, 1.83732159, 1.838980587, 1.840641081, 1.842303075, 1.843966569, 1.845631565, 1.847298065, 1.84896607, 1.85063558, 1.852306598, 1.853979125, 1.855653162, 1.857328711, 1.859005772, 1.860684348, 1.86236444, 1.864046048, 1.865729175, 1.867413822, 1.86909999, 1.87078768, 1.872476895, 1.874167634, 1.8758599, 1.877553694, 1.879249018, 1.880945872, 1.882644259, 1.884344179, 1.886045634, 1.887748625, 1.889453154, 1.891159223, 1.892866831, 1.894575982, 1.896286675, 1.897998914, 1.899712698, 1.90142803, 1.903144911, 1.904863342, 1.906583324, 1.90830486, 1.91002795, 1.911752596, 1.913478799, 1.915206561, 1.916935883, 1.918666767, 1.920399213, 1.922133224, 1.9238688, 1.925605944, 1.927344656, 1.929084938, 1.930826791, 1.932570217, 1.934315217, 1.936061793, 1.937809947, 1.939559678, 1.94131099, 1.943063882, 1.944818358, 1.946574418, 1.948332063, 1.950091295, 1.951852116, 1.953614527, 1.955378529, 1.957144124, 1.958911313, 1.960680098, 1.96245048, 1.964222461, 1.965996041, 1.967771223, 1.969548008, 1.971326397, 1.973106392, 1.974887994, 1.976671205, 1.978456026, 1.980242459, 1.982030505, 1.983820165, 1.985611441, 1.987404335, 1.989198847, 1.99099498, 1.992792734, 1.994592112, 1.996393115, 1.998195744};

const float ScaleFreqTable[]
						   ={8.17580, 8.66196, 9.17702, 9.72272, 10.30086, 10.91338, 11.56233, 12.24986, 12.97827, 13.75000, 14.56762, 15.43385, 16.35160, 17.32391, 18.35405, 19.44544, 20.60172, 21.82676, 23.12465, 24.49971, 25.95654, 27.50000, 29.13524, 30.86771, 32.70320, 34.64783, 36.70810, 38.89087, 41.20344, 43.65353, 46.24930, 48.99943, 51.91309, 55.00000, 58.27047, 61.73541, 65.40639, 69.29566, 73.41619, 77.78175, 82.40689, 87.30706, 92.49861, 97.99886, 103.82617, 110.00000, 116.54094, 123.47083, 130.81278, 138.59132, 146.83238, 155.56349, 164.81378, 174.61412, 184.99721, 195.99772, 207.65235, 220.00000, 233.08188, 246.94165, 261.62557, 277.18263, 293.66477, 311.12698, 329.62756, 349.22823, 369.99442, 391.99544, 415.30470, 440.00000, 466.16376, 493.88330, 523.25113, 554.36526, 587.32954, 622.25397, 659.25511, 698.45646, 739.98885, 783.99087, 830.60940, 880.00000, 932.32752, 987.76660, 1046.50226, 1108.73052, 1174.65907, 1244.50793, 1318.51023, 1396.91293, 1479.97769, 1567.98174, 1661.21879, 1760.00000, 1864.65505, 1975.53321, 2093.00452, 2217.46105, 2349.31814, 2489.01587, 2637.02046, 2793.82585, 2959.95538, 3135.96349, 3322.43758, 3520.00000, 3729.31009, 3951.06641, 4186.00904, 4434.92210, 4698.63629, 4978.03174, 5274.04091, 5587.65170, 5919.91076, 6271.92698, 6644.87516, 7040.00000, 7458.62018, 7902.13282, 8372.01809, 8869.84419, 9397.27257, 9956.06348, 10548.08182, 11175.30341, 11839.82153, 12543.85395, 13289.75032};


////public variables////
Operator au_operator[OPNUM];
SynthOutput au_out[CHNUM];
SynthFilterSettings flt_settings[CHNUM];
SynthSettings synth_settings;
uint8_t display_data[CHNUM];


///private variables////
RingBuffer32 delay_buffer;


BUFFER_STATUS cureSynthDelayBufferInit()
{
	return cureRingBufferU32Init(&delay_buffer, DELAYBUFFER_LENGTH);
}

BUFFER_STATUS cureSynthDelayBufferEnqueue(uint32_t *input)
{
	return cureRingBufferU32EnqueueIgnoreErr(&delay_buffer, input);
}

BUFFER_STATUS cureSynthDelayBufferGetElement(uint32_t *ret, uint16_t delaynum)
{
	return cureRingBufferU32GetElement(&delay_buffer, ret, delaynum, DELAYBUFFER_LENGTH);
}

void cureSynthUpdateDisplayData()
{
	uint32_t i;
	uint8_t buf;

	for(i=0; i<CHNUM; i++){
		display_data[i] = 0x00;
	}

	for(i=0; i<OPNUM; i++){

		buf = (au_operator[i].env.out * au_operator[i].velocity) >> 7 ;

		if(display_data[au_operator[i].ch] < buf){
			display_data[au_operator[i].ch] = buf;
		}
	}

	for(i=0; i<CHNUM; i++){
		display_data[i] = (display_data[i] * synth_settings.expression[i] * synth_settings.volume[i]) >> 14;
	}
}

uint32_t cureGenerateNoise(void)
{
	//Xorshift from wikipedia  https://en.wikipedia.org/wiki/Xorshift
	  static uint32_t y = 1234567890;
	  //y = y ^ (y << 13);
	  y = y ^ (y >> 17);
	  return y = y ^ (y << 5);
}

void cureSynthInitADSR(Operator *op)
{
	//Initialize sweeping position of pitchbend.
	if(SWEEP_DOWN == op->wav.pitch_sweep_type){
		op->wav.pitch_sweep_ScaleFactor = PitchbendTable[ PITCHTABLE_NUM - 1 ] - 1.0f;
	}else if(SWEEP_UP == op->wav.pitch_sweep_type){
		op->wav.pitch_sweep_ScaleFactor = PitchbendTable[0] - 1.0f;
	}

	//Initialize Wave generator and Ring-modulation generator
	op->wav.freq = op->wav.freqbuf;
	op->wav.pointer = 0.0;
	op->ringmod.pointer=0.0;
}

void _cureSynthApplyADSR(Operator *op){

	switch(op->env.stat){

		case ADSR_START:	//Apply fade-out effect in order to reduce pop noise.
			if(op->env.out >= (255 >> FADESAMPLE_BIT)){
				op->env.out -= (255 >> FADESAMPLE_BIT);
			}else{
				op->env.out=0;
			}

			if(op->env.idx >= (1 << FADESAMPLE_BIT)){
				op->env.idx=0;
				op->env.stat = ATTACK;
				cureSynthInitADSR(op);
			}
			break;

		case ATTACK:
				op->env.out = (op->env.idx * 255) / ( (op->env.attack + 1) * ADSR_SCALEFACTOR) ;

			if(op->env.idx >= ( (op->env.attack + 1) * ADSR_SCALEFACTOR)){
				op->env.out = 255;
				op->env.stat = DECAY;
				op->env.idx = 0;
			}
			break;

		case DECAY:
			if(op->env.decay > 0){
				op->env.out = 255 - ((255 - op->env.sustainLevel) * op->env.idx) / ( (op->env.decay + 1) * ADSR_SCALEFACTOR);
			}
			if(op->env.idx >= ( (op->env.decay + 1) * ADSR_SCALEFACTOR)){
				op->env.out = op->env.sustainLevel;
				op->env.stat = SUSTAIN;
				op->env.idx = 0;
			}
			break;

		case SUSTAIN:
			if(op->env.sustainRate > 0){	//if sustainRate is larger than 0, enable envelope control.
				if(op->env.idx >= (ADSR_SCALEFACTOR * 128 / op->env.sustainRate )){
					if(op->env.out > 0){
						op->env.out--;
					}else{
						op->env.out = 0;
						op->env.stat = ADSR_END;
					}
					op->env.idx=0;
				}
			}else{
				op->env.idx=0;
			}
			break;

		case RELEASE:
			if(op->env.release >0){
				if(op->env.idx >= ( 2 * op->env.release )){
					if(op->env.out > 0){
						op->env.out--;
					}else{
						op->env.out = 0;
						op->env.stat = ADSR_END;
					}
					op->env.idx=0;
				}
			}else{
				if(0 < op->env.out ){
					op->env.out--;
				}else{
					op->env.out = 0;
					op->env.idx=0;
					op->env.stat = ADSR_END;
				}
			}
			break;

		case ADSR_END:
			if(0 < op->env.out ){
				op->env.out--; //soft off(fade out)
			}else{
				op->env.out = 0;
				op->env.stat = ADSR_END;
				op->ch = 255;
			}
			break;

		default:
			op->env.out = 0;
			op->env.stat = ADSR_END;
			break;
	}

	op->env.idx++;

	return;
}

void cureSynthApplyModulation()
{
	uint32_t i;

	for(i=0; i<CHNUM; i++){

		if( ( MOD_PLL_DIV ) <= synth_settings.modulation_PLL_idx[i]){

			if( 0 != synth_settings.modulation[i] ){
				synth_settings.modulation_scalefactor[i] = ModTable[ synth_settings.modulation_pointer[i] ] * synth_settings.modulation[i] * MOD_AMPLITUDE  + 1.0f;
			}else{
				synth_settings.modulation_scalefactor[i] = (synth_settings.modulation_scalefactor[i] - 1.0f) * MOD_GAIN_SCALEFACTOR + 1.0f;
				synth_settings.modulation_pointer[i] = 0;
			}

			synth_settings.modulation_pointer[i] = (synth_settings.modulation_pointer[i] + 1) & ( MODTABLE_NUM - 1 );
			synth_settings.modulation_PLL_idx[i] -= MOD_PLL_DIV ;
		}
		synth_settings.modulation_PLL_idx[i] += (synth_settings.modulation_rate[i] + MOD_PLL_OFFSET );
	}

	//set Modulation scale-factor to Operator.
	for(i=0; i<OPNUM; i++){
		au_operator[i].wav.modScaleFactor = synth_settings.modulation_scalefactor[ au_operator[i].ch ];
	}
}

void cureSynthApplyPBControl(Operator *op)
{

	if( (PITCHTABLE_NUM - 1)  <= op->wav.pitch_sweep_idx ){

		op->env.stat = ADSR_END;
		return;
	}

	//PitchBend control Softly in order to avoid click noise.
	if( ADSR_END != op->env.stat){
		if( PITCH_CTR_DIV < op->wav.pitch_sweep_divider){
			if(SWEEP_DOWN == op->wav.pitch_sweep_type){

				op->wav.pitch_sweep_ScaleFactor = PitchbendTable[ PITCHTABLE_NUM - 1 - op->wav.pitch_sweep_idx] - 1.0f;
				op->wav.pitch_sweep_idx++;
				op->wav.pitch_sweep_divider -= PITCH_CTR_DIV;

			}else if(SWEEP_UP == op->wav.pitch_sweep_type){

				op->wav.pitch_sweep_ScaleFactor = PitchbendTable[ op->wav.pitch_sweep_idx] - 1.0f;
				op->wav.pitch_sweep_idx++;
				op->wav.pitch_sweep_divider -= PITCH_CTR_DIV;
			}else{
				op->wav.pitch_sweep_idx++;
				op->wav.pitch_sweep_divider -= PITCH_CTR_DIV;
			}
		}
		op->wav.pitch_sweep_divider += op->wav.pitch_sweep_spd;
	}

}

//Unused. Over sampling methods.
int16_t cureSynthGenerateSine(float pt, float ang)
{
	uint32_t i;
	uint32_t ret = 0;

	float ang_div = ang / OVERSAMPLING_NUM;

	for(i=0; i<OVERSAMPLING_NUM; i++){

		ret +=  SineTable[ (uint16_t)(pt) ];

		pt+= ang_div;//increment pointer.
		if( pt >= SAMPLE_NUM ){
			pt -= SAMPLE_NUM;
		}
	}

	return ret / OVERSAMPLING_NUM;

}

//Unused. Over sampling methods.
int16_t cureSynthGenerateSaw(float pt, float ang)
{
	uint32_t i;
	uint32_t ret = 0;

	float ang_div = ang / OVERSAMPLING_NUM;

	for(i=0; i<OVERSAMPLING_NUM; i++){

		ret += __SSAT( (int32_t)(AUDIO_MIN_NUM + ( (uint16_t)pt * const_saw_scalefactor )) , 16);

		pt+= ang_div;//increment pointer.
		if( pt >= SAMPLE_NUM ){
			pt -= SAMPLE_NUM;
		}
	}

	return ret / OVERSAMPLING_NUM;

}

//Unused. Over sampling methods.
int16_t cureSynthGenerateSquare(float pt, float ang)
{

	uint32_t i;
	uint32_t ret = 0;

	float ang_div = ang / OVERSAMPLING_NUM;

	for(i=0; i<OVERSAMPLING_NUM; i++){

		if(pt <= (SAMPLE_NUM_HALF ) ){
			ret += AUDIO_MIN_NUM;
		}else{
			ret += AUDIO_MAX_NUM;
		}

		pt+= ang_div;//increment pointer.
		if( pt >= SAMPLE_NUM ){
			pt -= SAMPLE_NUM;
		}
	}

	return ret / OVERSAMPLING_NUM;

}

void cureSynthSetDryOutput(Operator *op)
{

	//Calculate Pitch bend control
	cureSynthApplyPBControl(op);

	//Calculate pitch
	op->wav.angular = (uint32_t)( (1 << 16) * (const_pitch_scalefactor * op->wav.freq) * op->wav.pitchScaleFactor * op->wav.modScaleFactor * op->wav.pitch_sweep_ScaleFactor);

	//Calculate wavetable
	switch(op->wav.type){
		case SINE:
			op->wav.out = SineTable[ HIWORD(op->wav.pointer) ];
			break;

		case SQUARE:
			if( HIWORD(op->wav.pointer) <= (SAMPLE_NUM_HALF ) ){
				op->wav.out = AUDIO_MIN_NUM;
			}else{
				op->wav.out = AUDIO_MAX_NUM;
			}
			break;

		case SAW:
			op->wav.out = __SSAT( (int32_t)(AUDIO_MIN_NUM + ( HIWORD(op->wav.pointer) * const_saw_scalefactor ) ) , 16);
			break;

		case TRIANGLE:
			if( HIWORD(op->wav.pointer) <= (SAMPLE_NUM_HALF ) ){
				op->wav.out = AUDIO_MIN_NUM + ( HIWORD(op->wav.pointer) * const_triangle_scalefactor );
			}else{
				op->wav.out = AUDIO_MAX_NUM - ( (HIWORD(op->wav.pointer) - ( SAMPLE_NUM_HALF ))  * const_triangle_scalefactor );
			}
			break;

		case NOISE:
			op->wav.out =  ((cureGenerateNoise() + cureGenerateNoise()) & 65535)  + AUDIO_MIN_NUM;
			break;

		default:
			break;
	}


	op->wav.pointer += op->wav.angular;
	op->wav.pointer = op->wav.pointer & (SAMPLE_NUM * (1 << 16) - 1);

	//Calculate RingModulator
	op->ringmod.angular = (uint32_t)(op->wav.angular * op->ringmod.multiply);
	op->ringmod.out = ( SineTable[ HIWORD(op->ringmod.pointer) ] * (op->ringmod.gain) + ( AUDIO_MAX_NUM * ( 127 - op->ringmod.gain )) ) >> 7;

	op->ringmod.pointer += op->ringmod.angular;
	op->ringmod.pointer = op->ringmod.pointer & (SAMPLE_NUM * (1 << 16) - 1);

	//Calculate envelope(ADSR)
	_cureSynthApplyADSR(op);

	//Calculate WG * EG *  Vol * Exp * Vel * RingMod and normalize it.
	op->out = ( op->wav.out * op->ringmod.out );
	op->out = __SMULWB( ( op->out ),  (int16_t)__SSAT ( ( op->env.out * ( (op->velocity * op->out_gain) >> 6 ) ), 16 ) );
	op->out = op-> out >> (15 + OUTPUT_DIV_BIT);


	//set dry output to au_out[] ordering by 16 ch.
	if( CHNUM > op->ch ){
		au_out[op->ch].mono.right += op->out;
	}

	return;
}

void cureSynthPanSmoothing()
{
	uint8_t i;
	uint8_t *pan, *pan_ref;

	for(i=0; i<CHNUM; i++){
		pan = &synth_settings.pan[i];
		pan_ref = &synth_settings.pan_ref[i];

		if( (*pan_ref) != (*pan) ){
			 (*pan) += ( (*pan_ref) - (*pan) ) / abs( (*pan_ref) - (*pan) );
		}
	}

}

void cureSynthApplyPanAndDelay(int16_t output[2])
{
	uint32_t i;

	int32_t dly_buf_left=0, dly_buf_right=0;

	uint32_t op_out =0;

	SynthOutput dly_in = {0};
	SynthOutput dly_out = {0};

	//Smoothing Pan
	cureSynthPanSmoothing();

	//Generate Pan and Delay
	for(i=0; i<CHNUM; i++){
		au_out[i].mono.left = ( au_out[i].mono.right * PanTable[ synth_settings.pan[i] ] ) >> 7;
		au_out[i].mono.right = ( au_out[i].mono.right * PanTable[127 - synth_settings.pan[i] ] ) >> 7;

		op_out = __QADD16(op_out, au_out[i].stereo_out);

		dly_buf_left  += ( au_out[i].mono.left * synth_settings.delay_level[i] );
		dly_buf_right += ( au_out[i].mono.right * synth_settings.delay_level[i] );
	}
	dly_in.mono.left = dly_buf_left >>8;
	dly_in.mono.right = dly_buf_right >>8;

	cureSynthDelayBufferGetElement(&dly_out.stereo_out, synth_settings.delay_time * 2);

	if(synth_settings.delay_feedback_ison){
		dly_in.mono.left  = ((dly_out.mono.left * synth_settings.delay_feedback_gain) / 256) + dly_in.mono.left;
		dly_in.mono.right = ((dly_out.mono.right * synth_settings.delay_feedback_gain) / 256) + dly_in.mono.right;
	}

	cureSynthDelayBufferEnqueue(&dly_in.stereo_out);

	*(uint32_t *)output = __QADD16( dly_out.stereo_out , op_out);

	return;

}

void cureSynthApplyVolume()
{
	uint32_t i;

	for(i=0; i<CHNUM; i++){
		au_out[i].mono.right = (au_out[i].mono.right * synth_settings.volume[i] * synth_settings.expression[i]) >> 14;
	}
}

// Bi-Quad Filter
// referred to below
// http://aikelab.net/filter/
// http://vstcpp.wpblog.jp/?page_id=523
void cureSynthSetFilterParam(FilterType ftype, float fc, float Q, uint8_t ch)
{
	float omega, alpha, a0, a1, a2, b0, b1, b2;
	float coso;

	omega = 2.0f * M_PI * fc / SAMPLE_RATE;
	alpha = sin(omega) / (2.0f * Q);

	coso = cos(omega);

	if(LPF == ftype){

		a0 = 1.0f + alpha;
		a1 = -2.0f * coso;
		a2 = 1.0f - alpha;
		b0 = b2 = (1.0f - coso) / 2.0f;
		b1 = 1.0f - coso;

	}else{

		a0 = 1.0f + alpha;
		a1 = -2.0f * coso;
		a2 = 1.0f - alpha;
		b0 = b2 = (1.0f + coso) / 2.0f;
		b1 = -(1.0f - coso);
	}

	flt_settings[ch].b0a0 = b0 / a0;
	flt_settings[ch].b1a0 = b1 / a0;
	flt_settings[ch].b2a0 = b2 / a0;
	flt_settings[ch].a1a0 = a1 / a0;
	flt_settings[ch].a2a0 = a2 / a0;

}

// Bi-Quad Filter
// referred to below
// http://aikelab.net/filter/
// http://vstcpp.wpblog.jp/?page_id=523
void cureSynthApplyFilter()
{
	uint32_t i;
	int16_t input, output;

	for(i=0; i<CHNUM; i++){

		input = au_out[i].mono.right;

		output = (int16_t)
				( flt_settings[i].b0a0 * input
				+ flt_settings[i].b1a0 * flt_settings[i].in1
				+ flt_settings[i].b2a0 * flt_settings[i].in2
				- flt_settings[i].a1a0 * flt_settings[i].out1
				- flt_settings[i].a2a0 * flt_settings[i].out2 );

		flt_settings[i].in2 = flt_settings[i].in1;
		flt_settings[i].in1 = input;

		flt_settings[i].out2 = flt_settings[i].out1;
		flt_settings[i].out1 = output;

		au_out[i].mono.right = output;
	}
}

void cureSynthApplyDistortion()
{
	uint32_t i;
	int16_t input, output;

	for(i=0; i<CHNUM; i++){
		if( DIST_ON == synth_settings.dst_mode[i]){

			input = au_out[i].mono.right;

			output = __SSAT( (input * synth_settings.dst_level[i])  , 13 );
			output = __SSAT((output * synth_settings.dst_gain[i]) >> OUTPUT_DIST_DIV_BIT , 16);

			au_out[i].mono.right = output;
		}
	}
}


void cureSynthGetOutput(int16_t output[2])
{
	uint32_t i;

	//Initialize
	for(i=0; i<CHNUM; i++){
		au_out[i].stereo_out = 0U;
	}

	//Setting Modulation Parameter
	cureSynthApplyModulation();

	//Set dry output
	for(i=0; i<OPNUM; i++){
		cureSynthSetDryOutput(&au_operator[i]);
	}

	//Apply Volume and Expression
	cureSynthApplyVolume();

	//Apply Distortion
	cureSynthApplyDistortion();

	//Apply Bi-Quad Filter.
	cureSynthApplyFilter();

	//Apply Pan(monoral to stereo) and Delay.
	cureSynthApplyPanAndDelay(output);


	//Set Master OUTPUT
	output[0] = output[0] >> MASTER_OUTPUT_DIV_BIT;
	output[1] = output[1] >> MASTER_OUTPUT_DIV_BIT;

	return;
}

void cureSynthSetNoteON(Operator *op, uint8_t sc, uint8_t vel, uint8_t midich)
{
	op->wav.freqbuf = ScaleFreqTable[sc];
	op->velocity = vel;
	op->env.stat = ADSR_START;
	op->env.idx = 0;
	op->ringmod.pointer = op->wav.pointer = 0.0;
	op->stat = NOTE_ON;
	op->ch = midich;	//While Operator is making sound (Note-on to ADSR_END), op->ch is available.
}

void cureSynthSetNoteOFF(Operator *op)
{
	if( NOTE_MELODY == op->ntype){
		op->env.stat = RELEASE;
		op->env.idx = 0;
		op->stat = NOTE_OFF;
	}else{// if op->ntype == NOTE_DRUM, disable release.
		op->stat = NOTE_OFF;
	}

}

void cureSynthOperatorApplyPitchBend(Operator *op)
{
	int32_t bendOctave = 0, bendAfterDecimal = 0, tmp = 0;
	float scaleFactor = 1.0;

	uint8_t i;

	//Calculate PitchBend
	if(op->wav.pitch >=8192){
		tmp = ( (op->wav.pitch - 8192) * op->wav.pitchbendsensitivity * 64) / 8192;
		bendOctave = tmp / PITCHTABLE_NUM;
		bendAfterDecimal = tmp - PITCHTABLE_NUM * bendOctave;
		for(i=0; i<bendOctave; i++){
			scaleFactor *= 2.0;
		}
		scaleFactor *= PitchbendTable[bendAfterDecimal];

	}else{
		tmp = ( (8192 - op->wav.pitch) * op->wav.pitchbendsensitivity * 64) / 8192;
		bendOctave = tmp / PITCHTABLE_NUM;
		bendAfterDecimal = tmp - PITCHTABLE_NUM * bendOctave;
		for(i=0; i<bendOctave; i++){
			scaleFactor /= 2.0;
		}
		scaleFactor /= PitchbendTable[bendAfterDecimal];

	}
	op->wav.pitchScaleFactor = scaleFactor;
}

void cureSynthSetFilter(uint8_t ch)
{

	float fc,q;

	uint8_t ct, rs;

	ct = synth_settings.cutoff[ch];
	rs = synth_settings.resonance[ch];

	if( 64 >= ct){
		fc = FLT_FREQ_MIN + (float)ct * (FLT_FREQ_MID - FLT_FREQ_MIN) / 64.0f;
	}else{
		fc = FLT_FREQ_MID + (float)(ct - 64) * (FLT_FREQ_MAX - FLT_FREQ_MID) / 63.0f;
	}

	if( 64 >= rs){
		q = FLT_QFACT_MIN + ( (float)rs * (FLT_QFACT_MID - FLT_QFACT_MIN) ) / 64.0f;
	}else{
		q = FLT_QFACT_MID + ( (float)(rs - 64) * (FLT_QFACT_MAX - FLT_QFACT_MID) ) / 63.0f;
	}

	cureSynthSetFilterParam(synth_settings.ftype[ch], fc, q, ch);

}

void cureSynthAllSoundOff(uint8_t ch)
{
	uint32_t i;

	for(i=0; i<OPNUM; i++){
		if( ch == au_operator[i].ch){
			cureSynthOperatorInit(&au_operator[i]);
		}
	}
}

void cureSynthOperatorCopy(Operator *src, Operator *dest)//deep copy
{
	dest->wav.type = src->wav.type;
	dest->wav.freq = src->wav.freq;
	dest->wav.freqbuf = src->wav.freqbuf;
	dest->wav.pitch = src->wav.pitch;
	dest->wav.pitchbendsensitivity = src->wav.pitchbendsensitivity;
	dest->wav.pitchScaleFactor = src->wav.pitchScaleFactor;

	dest->wav.pitch_sweep_ScaleFactor = src->wav.pitch_sweep_ScaleFactor;
	dest->wav.pitch_sweep_idx = src->wav.pitch_sweep_idx;
	dest->wav.pitch_sweep_spd = src->wav.pitch_sweep_spd;
	dest->wav.pitch_sweep_divider = src->wav.pitch_sweep_divider;
	dest->wav.pitch_sweep_type = src->wav.pitch_sweep_type;

	dest->wav.modScaleFactor = src->wav.modScaleFactor;

	dest->wav.pointer = src->wav.pointer;
	dest->wav.angular = src->wav.angular;
	dest->wav.out = src->wav.out;

	dest->ringmod.type = src->ringmod.type;
	dest->ringmod.multiply = src->ringmod.multiply;
	dest->ringmod.gain = src->ringmod.gain;
	dest->ringmod.pointer = src->ringmod.pointer;
	dest->ringmod.angular = src->ringmod.angular;
	dest->ringmod.out = src->ringmod.out;

	dest->env.divider = src->env.divider;
	dest->env.idx = src->env.idx;
	dest->env.stat = src->env.stat;
	dest->env.attack = src->env.attack;
	dest->env.decay = src->env.decay;
	dest->env.sustainLevel = src->env.sustainLevel;
	dest->env.sustainRate = src->env.sustainRate;
	dest->env.release = src->env.release;
	dest->env.out = src->env.out;


	dest->stat = src->stat;
	dest->ntype = src->ntype;
	dest->velocity = src->velocity;
	dest->out = src->out;
	dest->leftout = src->leftout;
	dest->rightout = src->rightout;
	dest->out_gain = src->out_gain;

}

void cureSynthOperatorInit(Operator *op)
{
	op->wav.type = SINE;
	op->wav.freq = 0.0f;
	op->wav.freqbuf = 0.0f;
	op->wav.pitch = 0;
	op->wav.pitchbendsensitivity = 2;
	op->wav.pitchScaleFactor = 1.0f;

	op->wav.pitch_sweep_ScaleFactor = 1.0f;
	op->wav.pitch_sweep_idx = 0;
	op->wav.pitch_sweep_divider = 0;
	op->wav.pitch_sweep_spd = 0;
	op->wav.pitch_sweep_type = SWEEP_NONE;

	op->wav.modScaleFactor = 1.0f;

	op->wav.pointer = 0.0f;
	op->wav.angular = 0.0f;
	op->wav.out = 0;

	op->ringmod.type = SINE;
	op->ringmod.multiply = 0.5f;
	op->ringmod.gain = 100;
	op->ringmod.pointer = 0.0f;
	op->ringmod.angular = 0.0f;
	op->ringmod.out = 0;

	op->env.divider = 0;
	op->env.idx = 0;
	op->env.stat = ADSR_END;
	op->env.attack = 1;
	op->env.decay = 4;
	op->env.sustainLevel = 120;
	op->env.sustainRate = 5;
	op->env.release = 10;
	op->env.out = 0;

	op->stat = NOTE_OFF;
	op->ntype = NOTE_MELODY;
	op->velocity = 127;
	op->ch = 255;
	op->out = 0;
	op->rightout = 0;
	op->leftout = 0;
	op->out_gain = 64;
}

void cureSynthInit()
{
	uint32_t i;

	for(i=0; i<OPNUM; i++){
		cureSynthOperatorInit(&au_operator[i]);
	}

	if( BUFFER_FAILURE == cureSynthDelayBufferInit() ){
		while(1);
	}

	cureSynthSettingInit();
}

void cureSynthSettingInit()
{
	uint32_t i;

	synth_settings.mode = MODE_GM1;

	synth_settings.delay_time = 4000;
	synth_settings.delay_feedback_gain = 160;
	synth_settings.delay_feedback_ison = true;

	for(i=0; i<CHNUM; i++){
		au_out[i].stereo_out = 0U;

		synth_settings.volume[i] = 127;
		synth_settings.expression[i] = 127;

		synth_settings.delay_level[i] = 0;
		synth_settings.pan[i] = 64;
		synth_settings.pan_ref[i] = 64;

		synth_settings.ftype[i] = LPF;
		synth_settings.resonance[i] = 64;
		synth_settings.cutoff[i] = 64;

		synth_settings.modulation_pointer[i] = 0;
		synth_settings.modulation_angular[i] = 0;
		synth_settings.modulation_PLL_idx[i] = 0;
		synth_settings.modulation_scalefactor[i] = 1.0f;
		synth_settings.modulation[i] = 0;
		synth_settings.modulation_rate[i] = 64;

		synth_settings.tr_type[i] = TRACK_MELODY;

		synth_settings.dst_mode[i] = DIST_OFF;
		synth_settings.dst_gain[i] = 64;
		synth_settings.dst_level[i] = 127;
	}

	//ch9(or 10) set to Drum track
	synth_settings.tr_type[9] = TRACK_DRUM;

	for(i=0; i<CHNUM; i++){
		cureSynthSetFilter(i);
	}
}

